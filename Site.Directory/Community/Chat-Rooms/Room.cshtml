@page "{id:int}"
@model RoleplayersGuild.Site.Directory.Community.Chat_Rooms.RoomModel
@{
    ViewData["Title"] = Model.ChatRoom?.ChatRoomName ?? "Chat Room";
    Layout = "_Layout2Col";
}

@section cphLeftCol {
    <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">Active Chat Rooms</h5></div>
        <div id="ActiveChatRoomList" class="list-group list-group-flush">
            <p class="p-3 text-muted">Loading rooms...</p>
        </div>
        <div class="card-footer text-end small">
            <a asp-page="/User-Panel/My-Chat-Rooms/Index">My Chat Rooms</a> |
            <a asp-page="./Search">View All</a>
        </div>
    </div>

    @* --- UPDATED TO SHOW PARTICIPANTS --- *@
    <div class="card">
        <div class="card-header"><h5 class="mb-0">Characters in Room</h5></div>
        <div class="list-group list-group-flush">
            @if (!Model.Participants.Any())
            {
                <div class="list-group-item text-muted small">No participants yet.</div>
            }
            else
            {
                foreach (var p in Model.Participants)
                {
                    <a asp-page="/Community/Characters/View" asp-route-id="@p.CharacterId" class="list-group-item list-group-item-action d-flex align-items-center">
                        <img src="@(p.AvatarImageUrl ?? "/images/Defaults/NewAvatar.png")" class="chat-avatar me-2" alt="@p.CharacterDisplayName avatar" />
                        <span class="text-truncate">@p.CharacterDisplayName</span>
                    </a>
                }
            }
        </div>
    </div>
}

@section cphRightCol {
    @* --- RESTRUCTURED CHAT PANEL WITH CARD LAYOUT --- *@
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">@Model.ChatRoom!.ChatRoomName</h5>
                <a href="#" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#ChatInfoModal">Rules & Information</a>
            </div>
        </div>
        <div class="card-body">
            <div class="chat-posts-container">
                <div id="ChatOutput" class="ChatPosts">
                    <p class="text-center"><img src="/images/Icons/spin.gif" alt="Loading Spinner" /> Loading Chat...</p>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <div class="row gx-3 gy-2 align-items-center mb-3">
                <div class="col-md-5 col-lg-4">
                    <label class="visually-hidden" for="ddlSendAs">Send As:</label>
                    <div class="input-group">
                        <span class="input-group-text">Send As:</span>
                        <select id="ddlSendAs" class="form-select">
                            @if (Model.UserCharacters != null && Model.UserCharacters.Any())
                            {
                                @foreach (var character in Model.UserCharacters)
                                {
                                    <option value="@character.CharacterId" selected="@(character.CharacterId == Model.CurrentSendAsCharacterId)">
                                        @character.CharacterDisplayName
                                    </option>
                                }
                            }
                            else
                            {
                                <option value="0">No Character</option>
                            }
                        </select>
                    </div>
                </div>
            </div>
            <div class="row MakePost g-2">
                <div class="col">
                    <textarea id="txtPostContent" class="form-control" rows="3" placeholder="Type your message..."></textarea>
                </div>
                <div class="col-auto">
                    <button id="btnSubmitPost" class="btn btn-primary h-100">Submit Post</button>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="chatRoomId" value="@Model.ChatRoom.ChatRoomId" />
    <div class="modal fade" id="ChatInfoModal" tabindex="-1" aria-labelledby="ChatInfoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ChatInfoLabel">@Model.ChatRoom!.ChatRoomName Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body linkify">
                    @Html.Raw(Model.ChatRoom.ChatRoomDescription)
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
}